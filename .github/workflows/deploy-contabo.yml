# ============================================================================
# GITHUB ACTIONS - DEPLOY AUTOMÃTICO BACKEND NFE PARA CONTABO
# ============================================================================
# Servidor: 147.93.186.214 (Ubuntu 24.04.3 LTS)
# Fluxo: GitHub Push â†’ Deploy AutomÃ¡tico â†’ Restart PM2
# Sistema: 100% JSON Database
# ============================================================================

name: ğŸš€ Deploy Backend NFe para Contabo

on:
  push:
    branches: [ main, master ]
    paths:
      - '**'
      - '.github/workflows/deploy-contabo.yml'
      - 'ecosystem.config.js'

  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'ForÃ§ar deploy mesmo sem mudanÃ§as'
        required: false
        default: 'false'
        type: boolean
      skip_tests:
        description: 'Pular testes (apenas para emergÃªncia)'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '22.x'
  SERVER_HOST: '147.93.186.214'
  SERVER_USER: 'nfeapp'  # UsuÃ¡rio nÃ£o-root para deploy
  SERVER_PORT: '22'
  DEPLOY_PATH: '/home/nfeapp/brandaocontador-nfe-backend'
  PM2_APP_NAME: 'nfe-backend'

jobs:
  # ============================================================================
  # JOB 1: TESTES E VALIDAÃ‡ÃƒO
  # ============================================================================
  test:
    name: ğŸ§ª Testes e ValidaÃ§Ã£o
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          cd backend
          npm ci --only=production

      - name: ğŸ” Verificar estrutura de arquivos
        run: |
          echo "ğŸ” Verificando arquivos essenciais..."
          test -f backend/app.js || (echo "âŒ backend/app.js nÃ£o encontrado" && exit 1)
          test -f backend/package.json || (echo "âŒ backend/package.json nÃ£o encontrado" && exit 1)
          test -f backend/ecosystem.config.js || (echo "âŒ backend/ecosystem.config.js nÃ£o encontrado" && exit 1)
          echo "âœ… Todos os arquivos essenciais encontrados"

      - name: ğŸ§ª Executar testes bÃ¡sicos
        run: |
          echo "ğŸ§ª Executando validaÃ§Ãµes bÃ¡sicas..."
          node -c backend/app.js || (echo "âŒ Erro de sintaxe em app.js" && exit 1)
          echo "âœ… ValidaÃ§Ã£o de sintaxe passou"

      - name: ğŸ“Š Verificar estrutura JSON
        run: |
          echo "ğŸ“Š Verificando estrutura de dados JSON..."
          if [ -d "backend/data" ]; then
            echo "âœ… DiretÃ³rio data encontrado"
            for file in backend/data/*.json; do
              if [ -f "$file" ]; then
                echo "ğŸ” Validando $file..."
                python3 -m json.tool "$file" > /dev/null || (echo "âŒ JSON invÃ¡lido: $file" && exit 1)
              fi
            done
            echo "âœ… Todos os arquivos JSON sÃ£o vÃ¡lidos"
          else
            echo "âš ï¸ DiretÃ³rio data nÃ£o encontrado (serÃ¡ criado no deploy)"
          fi

  # ============================================================================
  # JOB 2: DEPLOY NO SERVIDOR CONTABO
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy para Contabo
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Preparar ambiente de deploy
        run: |
          echo "ğŸ”§ Preparando ambiente..."
          mkdir -p ~/.ssh
          echo "${{ secrets.CONTABO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Adicionar fingerprint do servidor ao known_hosts
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

          echo "Host ${{ env.SERVER_HOST }}" >> ~/.ssh/config
          echo "  HostName ${{ env.SERVER_HOST }}" >> ~/.ssh/config
          echo "  User ${{ env.SERVER_USER }}" >> ~/.ssh/config
          echo "  Port ${{ env.SERVER_PORT }}" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: ğŸŒ Testar conectividade com servidor
        run: |
          echo "ğŸŒ Testando conectividade com CONTABO..."
          ssh -o ConnectTimeout=10 ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "echo 'âœ… ConexÃ£o SSH estabelecida com sucesso na CONTABO'"

      - name: ğŸ“¦ Preparar arquivos para deploy
        run: |
          echo "ğŸ“¦ Preparando arquivos para CONTABO..."

          # Criar diretÃ³rio temporÃ¡rio
          echo "ğŸ—‚ï¸ Criando diretÃ³rio temporÃ¡rio..."
          mkdir -p /tmp/deploy-temp

          # Copiar arquivos necessÃ¡rios (excluindo os que nÃ£o queremos)
          echo "ğŸ“‹ Copiando arquivos (excluindo dados sensÃ­veis)..."
          rsync -av \
            --exclude=node_modules \
            --exclude=data \
            --exclude=.git \
            --exclude=.github \
            --exclude=*.log \
            --exclude=backend/backend \
            --exclude=logs \
            --exclude=pdfs \
            --exclude=xmls \
            --exclude=.env \
            backend/ /tmp/deploy-temp/

          # Criar tar do diretÃ³rio temporÃ¡rio
          echo "ğŸ“¦ Criando arquivo tar..."
          cd /tmp/deploy-temp
          tar -czf /tmp/backend-deploy.tar.gz .

          # Mover arquivo para o workspace
          echo "ğŸ“ Movendo arquivo para workspace..."
          mv /tmp/backend-deploy.tar.gz $GITHUB_WORKSPACE/

          echo "ğŸ“Š Arquivo criado com sucesso:"
          ls -lh $GITHUB_WORKSPACE/backend-deploy.tar.gz

      - name: ğŸš€ Transferir arquivos para servidor
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ secrets.CONTABO_SSH_PRIVATE_KEY }}
          port: ${{ env.SERVER_PORT }}
          source: "backend-deploy.tar.gz"
          target: "/tmp/"

      - name: ğŸ”„ Executar deploy no servidor
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ secrets.CONTABO_SSH_PRIVATE_KEY }}
          port: ${{ env.SERVER_PORT }}
          script: |
            set -e

            echo "ğŸ”„ Iniciando processo de deploy na CONTABO..."

            # Verificar se dependÃªncias estÃ£o disponÃ­veis
            echo "ğŸ”§ Verificando ambiente..."

            if ! command -v node &> /dev/null; then
              echo "âŒ Node.js nÃ£o encontrado no servidor. Por favor, instale Node.js primeiro."
              exit 1
            fi
            echo "âœ… Node.js encontrado: $(node --version)"

            if ! command -v npm &> /dev/null; then
              echo "âŒ npm nÃ£o encontrado no servidor. Por favor, instale npm primeiro."
              exit 1
            fi
            echo "âœ… npm encontrado: $(npm --version)"

            if ! command -v pm2 &> /dev/null; then
              echo "âŒ PM2 nÃ£o encontrado no servidor. Por favor, instale PM2 primeiro."
              exit 1
            fi
            echo "âœ… PM2 encontrado: $(pm2 --version)"

            echo "âœ… Ambiente verificado - todas as dependÃªncias estÃ£o disponÃ­veis"
            echo "ğŸš€ Servidor Contabo configurado com Node.js v18.19.1, npm 9.2.0, PM2 6.0.13"

            # Criar backup antes do deploy
            BACKUP_DIR="/var/backups/brandaocontador-nfe-backend/$(date +%Y%m%d_%H%M%S)"
            echo "ğŸ’¾ Criando backup em: $BACKUP_DIR"
            mkdir -p "$BACKUP_DIR"

            if [ -d "${{ env.DEPLOY_PATH }}" ]; then
              cp -r "${{ env.DEPLOY_PATH }}" "$BACKUP_DIR/"
              echo "âœ… Backup criado com sucesso"
            fi

            # Usar pm2 reload para zero downtime (ao invÃ©s de stop/start)
            echo "ğŸ”„ Recarregando aplicaÃ§Ã£o (zero downtime)..."
            if pm2 list | grep -q "${{ env.PM2_APP_NAME }}"; then
              pm2 reload ${{ env.PM2_APP_NAME }} || echo "âš ï¸ Reload falhou, tentando restart..."
            else
              echo "âš ï¸ AplicaÃ§Ã£o nÃ£o estava rodando, serÃ¡ iniciada"
            fi

            # Extrair novos arquivos
            echo "ğŸ“¦ Extraindo novos arquivos..."
            cd /tmp
            tar -xzf backend-deploy.tar.gz

            # Criar diretÃ³rio se nÃ£o existir
            mkdir -p "${{ env.DEPLOY_PATH }}"

            # Copiar arquivos (preservando data/ existente)
            echo "ğŸ“ Copiando arquivos..."
            cp -r . "${{ env.DEPLOY_PATH }}/"

            # Configurar permissÃµes
            echo "ğŸ” Configurando permissÃµes..."
            chmod -R 755 "${{ env.DEPLOY_PATH }}"

            # Instalar dependÃªncias
            echo "ğŸ“¦ Instalando dependÃªncias..."
            cd "${{ env.DEPLOY_PATH }}"
            npm install --production --no-audit --no-fund

            # Criar estrutura de dados JSON APENAS se pasta data/ nÃ£o existir
            echo "ğŸ“Š Verificando estrutura de dados JSON..."
            if [ ! -d "data" ]; then
              echo "ğŸ“ Criando estrutura inicial de dados..."
              mkdir -p data

              # Criar arquivos JSON se nÃ£o existirem
              for file in clientes.json configuracoes.json database.json logs.json nfes.json produtos.json usuarios.json; do
                if [ ! -f "data/$file" ]; then
                  echo "[]" | tee "data/$file" > /dev/null
                  echo "âœ… Criado: data/$file"
                fi
              done
            else
              echo "âœ… Estrutura de dados existente preservada"
            fi

            # Iniciar aplicaÃ§Ã£o se nÃ£o estava rodando
            if ! pm2 list | grep -q "${{ env.PM2_APP_NAME }}"; then
              echo "ğŸš€ Iniciando aplicaÃ§Ã£o..."
              pm2 start ecosystem.config.js --env production
              pm2 save
            fi

            # Aguardar inicializaÃ§Ã£o
            sleep 5

            echo "âœ… Deploy concluÃ­do com sucesso na CONTABO!"

      - name: ğŸ¥ Verificar saÃºde da aplicaÃ§Ã£o
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ secrets.CONTABO_SSH_PRIVATE_KEY }}
          port: ${{ env.SERVER_PORT }}
          script: |
            # VerificaÃ§Ã£o rÃ¡pida se PM2 estÃ¡ rodando
            if pm2 list | grep -q "${{ env.PM2_APP_NAME }}"; then
              echo "âœ… AplicaÃ§Ã£o rodando no PM2"
              echo "ğŸ‰ Deploy verificado com sucesso na CONTABO!"
            else
              echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ rodando no PM2"
              exit 1
            fi

      - name: ğŸ§¹ Limpeza pÃ³s-deploy
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ secrets.CONTABO_SSH_PRIVATE_KEY }}
          port: ${{ env.SERVER_PORT }}
          script: |
            echo "ğŸ§¹ Limpando arquivos temporÃ¡rios na CONTABO..."
            rm -f /tmp/backend-deploy.tar.gz
            echo "âœ… Limpeza concluÃ­da na CONTABO"

  # ============================================================================
  # JOB 3: NOTIFICAÃ‡Ã•ES
  # ============================================================================
  notify:
    name: ğŸ“¢ NotificaÃ§Ãµes
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()

    steps:
      - name: ğŸ“¢ Notificar resultado do deploy
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ğŸ‰ DEPLOY REALIZADO COM SUCESSO NA CONTABO!"
            echo "âœ… Backend NFe atualizado no servidor CONTABO"
            echo "ğŸŒ Servidor: ${{ env.SERVER_HOST }} (Ubuntu 24.04.3 LTS)"
            echo "ğŸ“Š Sistema: 100% JSON Database"
            echo "ğŸ“… Data: $(date)"
            echo "ğŸ”— Commit: ${{ github.sha }}"
            echo "ğŸš€ URL: https://api.brandaocontador.com.br"
          else
            echo "âŒ FALHA NO DEPLOY NA CONTABO!"
            echo "ğŸš¨ Verificar logs para mais detalhes"
            echo "ğŸ”— Commit: ${{ github.sha }}"
            echo "ğŸŒ Servidor: ${{ env.SERVER_HOST }}"
          fi

      # Aqui vocÃª pode adicionar integraÃ§Ãµes com Discord, Slack, etc.
      # - name: ğŸ“± Notificar Discord
      #   if: always()
      #   uses: sarisia/actions-status-discord@v1
      #   with:
      #     webhook: ${{ secrets.DISCORD_WEBHOOK }}
      #     status: ${{ job.status }}
      #     title: "Deploy Backend NFe"
      #     description: "Deploy automÃ¡tico para servidor Contabo"