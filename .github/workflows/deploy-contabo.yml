# ============================================================================
# GITHUB ACTIONS - DEPLOY AUTOMÃTICO BACKEND NFE PARA CONTABO
# ============================================================================
# Servidor: 147.93.186.214 (Ubuntu 24.04.3 LTS)
# Fluxo: GitHub Push â†’ Deploy AutomÃ¡tico â†’ Restart PM2
# Sistema: 100% JSON Database
# ============================================================================

name: ğŸš€ Deploy Backend NFe para Contabo

on:
  push:
    branches: [ main, master ]
    paths:
      - '**'
      - '.github/workflows/deploy-contabo.yml'
      - 'ecosystem.config.js'
  
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'ForÃ§ar deploy mesmo sem mudanÃ§as'
        required: false
        default: 'false'
        type: boolean
      skip_tests:
        description: 'Pular testes (apenas para emergÃªncia)'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '22.x'
  SERVER_HOST: '147.93.186.214'
  SERVER_USER: 'root'
  SERVER_PORT: '22'
  DEPLOY_PATH: '/var/www/brandaocontador-nfe-backend'
  PM2_APP_NAME: 'nfe-backend'

jobs:
  # ============================================================================
  # JOB 1: TESTES E VALIDAÃ‡ÃƒO
  # ============================================================================
  test:
    name: ğŸ§ª Testes e ValidaÃ§Ã£o
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
          
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          cd backend
          npm ci --only=production
          
      - name: ğŸ” Verificar estrutura de arquivos
        run: |
          echo "ğŸ” Verificando arquivos essenciais..."
          test -f backend/app.js || (echo "âŒ app.js nÃ£o encontrado" && exit 1)
          test -f backend/package.json || (echo "âŒ package.json nÃ£o encontrado" && exit 1)
          test -f ecosystem-production.config.js || (echo "âŒ ecosystem-production.config.js nÃ£o encontrado" && exit 1)
          echo "âœ… Todos os arquivos essenciais encontrados"
          
      - name: ğŸ§ª Executar testes bÃ¡sicos
        run: |
          cd backend
          echo "ğŸ§ª Executando validaÃ§Ãµes bÃ¡sicas..."
          node -c app.js || (echo "âŒ Erro de sintaxe em app.js" && exit 1)
          echo "âœ… ValidaÃ§Ã£o de sintaxe passou"
          
      - name: ğŸ“Š Verificar estrutura JSON
        run: |
          echo "ğŸ“Š Verificando estrutura de dados JSON..."
          cd backend
          if [ -d "data" ]; then
            echo "âœ… DiretÃ³rio data encontrado"
            for file in data/*.json; do
              if [ -f "$file" ]; then
                echo "ğŸ” Validando $file..."
                python3 -m json.tool "$file" > /dev/null || (echo "âŒ JSON invÃ¡lido: $file" && exit 1)
              fi
            done
            echo "âœ… Todos os arquivos JSON sÃ£o vÃ¡lidos"
          else
            echo "âš ï¸ DiretÃ³rio data nÃ£o encontrado (serÃ¡ criado no deploy)"
          fi

  # ============================================================================
  # JOB 2: DEPLOY NO SERVIDOR CONTABO
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy para Contabo
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Preparar ambiente de deploy
        run: |
          echo "ğŸ”§ Preparando ambiente..."
          mkdir -p ~/.ssh
          echo "Host ${{ env.SERVER_HOST }}" >> ~/.ssh/config
          echo "  HostName ${{ env.SERVER_HOST }}" >> ~/.ssh/config
          echo "  User ${{ env.SERVER_USER }}" >> ~/.ssh/config
          echo "  Port ${{ env.SERVER_PORT }}" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
          chmod 600 ~/.ssh/config
          
      - name: ğŸ” Configurar autenticaÃ§Ã£o SSH
        run: |
          echo "ğŸ” Configurando SSH..."
          # Instalar sshpass para autenticaÃ§Ã£o por senha
          sudo apt-get update
          sudo apt-get install -y sshpass
          
      - name: ğŸŒ Testar conectividade com servidor
        run: |
          echo "ğŸŒ Testando conectividade com CONTABO..."
          sshpass -p "${{ secrets.CONTABO_SSH_PASSWORD }}" ssh -o ConnectTimeout=10 ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "echo 'âœ… ConexÃ£o SSH estabelecida com sucesso na CONTABO'"
          
      - name: ğŸ“¦ Preparar arquivos para deploy
        run: |
          echo "ğŸ“¦ Preparando arquivos para CONTABO..."
          # Criar arquivo temporÃ¡rio com arquivos essenciais
          tar -czf backend-deploy.tar.gz \
            backend/ \
            ecosystem.config.js \
            --exclude=backend/node_modules \
            --exclude=backend/logs \
            --exclude=backend/coverage \
            --exclude=backend/.env \
            --exclude=backend/certs \
            --exclude=backend/data/logs.json
          
          echo "ğŸ“Š Tamanho do arquivo de deploy:"
          ls -lh backend-deploy.tar.gz
          
      - name: ğŸš€ Transferir arquivos para servidor
        run: |
          echo "ğŸš€ Transferindo arquivos para CONTABO..."
          sshpass -p "${{ secrets.CONTABO_SSH_PASSWORD }}" scp -o ConnectTimeout=30 \
            backend-deploy.tar.gz \
            ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:/tmp/
            
          echo "âœ… Arquivos transferidos com sucesso para CONTABO"
          
      - name: ğŸ”„ Executar deploy no servidor
        run: |
          echo "ğŸ”„ Executando deploy na CONTABO..."
          sshpass -p "${{ secrets.CONTABO_SSH_PASSWORD }}" ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'EOF'
            set -e
            
            echo "ğŸ”„ Iniciando processo de deploy na CONTABO..."
            
            # Criar backup antes do deploy
            BACKUP_DIR="/var/backups/brandaocontador-nfe-backend/$(date +%Y%m%d_%H%M%S)"
            echo "ğŸ’¾ Criando backup em: $BACKUP_DIR"
            mkdir -p "$BACKUP_DIR"
            
            if [ -d "${{ env.DEPLOY_PATH }}" ]; then
              cp -r "${{ env.DEPLOY_PATH }}" "$BACKUP_DIR/"
              echo "âœ… Backup criado com sucesso"
            fi
            
            # Parar aplicaÃ§Ã£o atual
            echo "â¹ï¸ Parando aplicaÃ§Ã£o atual..."
            pm2 stop ${{ env.PM2_APP_NAME }} || echo "âš ï¸ AplicaÃ§Ã£o nÃ£o estava rodando"
            
            # Extrair novos arquivos
            echo "ğŸ“¦ Extraindo novos arquivos..."
            cd /tmp
            tar -xzf backend-deploy.tar.gz
            
            # Criar diretÃ³rio se nÃ£o existir
            mkdir -p "${{ env.DEPLOY_PATH }}"
            
            # Copiar arquivos
            echo "ğŸ“ Copiando arquivos..."
            cp -r backend/* "${{ env.DEPLOY_PATH }}/"
            cp ecosystem.config.js "${{ env.DEPLOY_PATH }}/"
            
            # Configurar permissÃµes
            echo "ğŸ” Configurando permissÃµes..."
            chmod -R 755 "${{ env.DEPLOY_PATH }}"
            
            # Instalar dependÃªncias
            echo "ğŸ“¦ Instalando dependÃªncias..."
            cd "${{ env.DEPLOY_PATH }}"
            npm install --production --no-audit --no-fund
            
            # Criar estrutura de dados JSON se nÃ£o existir
            echo "ğŸ“Š Verificando estrutura de dados JSON..."
            mkdir -p data
            
            # Criar arquivos JSON se nÃ£o existirem
            for file in clientes.json configuracoes.json database.json logs.json nfes.json produtos.json usuarios.json; do
              if [ ! -f "data/$file" ]; then
                echo "[]" | tee "data/$file" > /dev/null
                echo "âœ… Criado: data/$file"
              fi
            done
            
            # Iniciar aplicaÃ§Ã£o
            echo "ğŸš€ Iniciando aplicaÃ§Ã£o..."
            pm2 start ecosystem.config.js --env production
            pm2 save
            
            # Aguardar inicializaÃ§Ã£o
            sleep 5
            
            echo "âœ… Deploy concluÃ­do com sucesso na CONTABO!"
          EOF
          
      - name: ğŸ¥ Verificar saÃºde da aplicaÃ§Ã£o
        run: |
          echo "ğŸ¥ Verificando saÃºde da aplicaÃ§Ã£o na CONTABO..."
          sshpass -p "${{ secrets.CONTABO_SSH_PASSWORD }}" ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'EOF'
            # Verificar se PM2 estÃ¡ rodando
            if pm2 list | grep -q "${{ env.PM2_APP_NAME }}"; then
              echo "âœ… AplicaÃ§Ã£o estÃ¡ rodando no PM2"
            else
              echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ rodando no PM2"
              exit 1
            fi
            
            # Verificar se porta estÃ¡ escutando
            if netstat -tlnp | grep -q ":3000"; then
              echo "âœ… AplicaÃ§Ã£o estÃ¡ escutando na porta 3000"
            else
              echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ escutando na porta 3000"
              exit 1
            fi
            
            # Teste bÃ¡sico de conectividade
            if curl -f -s http://localhost:3000/api/health >/dev/null 2>&1; then
              echo "âœ… API respondendo corretamente"
            else
              echo "âš ï¸ API pode nÃ£o estar respondendo - verificando logs..."
              pm2 logs ${{ env.PM2_APP_NAME }} --lines 10
            fi
            
            # Mostrar status PM2
            echo "ğŸ“Š Status PM2:"
            pm2 list
            
            # Verificar estrutura JSON
            echo "ğŸ“Š Verificando estrutura JSON:"
            ls -la ${{ env.DEPLOY_PATH }}/data/
            
            echo "ğŸ‰ Deploy verificado com sucesso na CONTABO!"
          EOF
          
      - name: ğŸ§¹ Limpeza pÃ³s-deploy
        if: always()
        run: |
          echo "ğŸ§¹ Limpando arquivos temporÃ¡rios na CONTABO..."
          sshpass -p "${{ secrets.CONTABO_SSH_PASSWORD }}" ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} \
            "rm -f /tmp/backend-deploy.tar.gz"
          echo "âœ… Limpeza concluÃ­da na CONTABO"

  # ============================================================================
  # JOB 3: NOTIFICAÃ‡Ã•ES
  # ============================================================================
  notify:
    name: ğŸ“¢ NotificaÃ§Ãµes
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()
    
    steps:
      - name: ğŸ“¢ Notificar resultado do deploy
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ğŸ‰ DEPLOY REALIZADO COM SUCESSO NA CONTABO!"
            echo "âœ… Backend NFe atualizado no servidor CONTABO"
            echo "ğŸŒ Servidor: ${{ env.SERVER_HOST }} (Ubuntu 24.04.3 LTS)"
            echo "ğŸ“Š Sistema: 100% JSON Database"
            echo "ğŸ“… Data: $(date)"
            echo "ğŸ”— Commit: ${{ github.sha }}"
            echo "ğŸš€ URL: https://api.brandaocontador.com.br"
          else
            echo "âŒ FALHA NO DEPLOY NA CONTABO!"
            echo "ğŸš¨ Verificar logs para mais detalhes"
            echo "ğŸ”— Commit: ${{ github.sha }}"
            echo "ğŸŒ Servidor: ${{ env.SERVER_HOST }}"
          fi
          
      # Aqui vocÃª pode adicionar integraÃ§Ãµes com Discord, Slack, etc.
      # - name: ğŸ“± Notificar Discord
      #   if: always()
      #   uses: sarisia/actions-status-discord@v1
      #   with:
      #     webhook: ${{ secrets.DISCORD_WEBHOOK }}
      #     status: ${{ job.status }}
      #     title: "Deploy Backend NFe"
      #     description: "Deploy automÃ¡tico para servidor Contabo"