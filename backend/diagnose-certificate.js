require('dotenv').config();
const fs = require('fs');
const forge = require('node-forge');
const https = require('https');
const axios = require('axios');

const config = {
    certificadoPath: process.env.CERT_PATH,
    certificadoSenha: process.env.CERT_PASS,
    cnpj: process.env.CNPJ_EMITENTE
};

class DiagnosticoCertificado {
    constructor() {
        this.certificado = null;
        this.chavePrivada = null;
    }

    async carregarCertificado() {
        console.log('üîê Carregando e analisando certificado...');
        
        try {
            const certificadoBuffer = fs.readFileSync(config.certificadoPath);
            const p12Asn1 = forge.asn1.fromDer(certificadoBuffer.toString('binary'));
            const p12 = forge.pkcs12.pkcs12FromAsn1(p12Asn1, config.certificadoSenha);
            
            // Extrair certificado e chave privada
            const bags = p12.getBags({ bagType: forge.pki.oids.certBag });
            const certBag = bags[forge.pki.oids.certBag][0];
            this.certificado = certBag.cert;
            
            const keyBags = p12.getBags({ bagType: forge.pki.oids.pkcs8ShroudedKeyBag });
            const keyBag = keyBags[forge.pki.oids.pkcs8ShroudedKeyBag][0];
            this.chavePrivada = keyBag.key;
            
            console.log('‚úÖ Certificado carregado com sucesso');
            return true;
            
        } catch (error) {
            console.error('‚ùå Erro ao carregar certificado:', error.message);
            return false;
        }
    }

    analisarCertificado() {
        console.log('\nüîç AN√ÅLISE DETALHADA DO CERTIFICADO');
        console.log('=' .repeat(50));
        
        try {
            const subject = this.certificado.subject;
            const issuer = this.certificado.issuer;
            const extensions = this.certificado.extensions;
            
            console.log('üìã DADOS DO TITULAR:');
            subject.attributes.forEach(attr => {
                console.log(`  ${attr.name}: ${attr.value}`);
            });
            
            console.log('\nüè¢ AUTORIDADE CERTIFICADORA:');
            issuer.attributes.forEach(attr => {
                console.log(`  ${attr.name}: ${attr.value}`);
            });
            
            console.log('\nüìÖ VALIDADE:');
            console.log(`  V√°lido de: ${this.certificado.validity.notBefore}`);
            console.log(`  V√°lido at√©: ${this.certificado.validity.notAfter}`);
            
            const agora = new Date();
            const valido = agora >= this.certificado.validity.notBefore && agora <= this.certificado.validity.notAfter;
            console.log(`  Status: ${valido ? '‚úÖ V√ÅLIDO' : '‚ùå EXPIRADO/INV√ÅLIDO'}`);
            
            console.log('\nüîß EXTENS√ïES:');
            extensions.forEach(ext => {
                console.log(`  ${ext.name}: ${ext.value || 'Presente'}`);
            });
            
            // Verificar se √© certificado A1 para NFe
            const keyUsage = extensions.find(ext => ext.name === 'keyUsage');
            const extKeyUsage = extensions.find(ext => ext.name === 'extKeyUsage');
            
            console.log('\nüéØ VERIFICA√á√ÉO PARA NFe:');
            
            // Verificar CNPJ no certificado
            const cnpjCert = this.extrairCNPJCertificado();
            console.log(`  CNPJ no certificado: ${cnpjCert}`);
            console.log(`  CNPJ configurado: ${config.cnpj}`);
            console.log(`  CNPJ compat√≠vel: ${cnpjCert === config.cnpj.replace(/\D/g, '') ? '‚úÖ SIM' : '‚ùå N√ÉO'}`);
            
            // Verificar tipo de certificado
            const tipoA1 = this.verificarTipoA1();
            console.log(`  Tipo A1: ${tipoA1 ? '‚úÖ SIM' : '‚ùå N√ÉO'}`);
            
            // Verificar uso para assinatura digital
            const assinaturaDigital = this.verificarAssinaturaDigital();
            console.log(`  Assinatura Digital: ${assinaturaDigital ? '‚úÖ SIM' : '‚ùå N√ÉO'}`);
            
            return {
                valido,
                cnpjCompativel: cnpjCert === config.cnpj.replace(/\D/g, ''),
                tipoA1,
                assinaturaDigital
            };
            
        } catch (error) {
            console.error('‚ùå Erro na an√°lise:', error.message);
            return null;
        }
    }

    extrairCNPJCertificado() {
        try {
            const subject = this.certificado.subject;
            
            // Procurar CNPJ no CN (Common Name)
            const cn = subject.attributes.find(attr => attr.name === 'commonName');
            if (cn && cn.value) {
                const cnpjMatch = cn.value.match(/(\d{14})/);
                if (cnpjMatch) {
                    return cnpjMatch[1];
                }
            }
            
            // Procurar em outros campos
            const serialNumber = subject.attributes.find(attr => attr.name === 'serialNumber');
            if (serialNumber && serialNumber.value) {
                const cnpjMatch = serialNumber.value.match(/(\d{14})/);
                if (cnpjMatch) {
                    return cnpjMatch[1];
                }
            }
            
            return 'N√ÉO ENCONTRADO';
            
        } catch (error) {
            return 'ERRO NA EXTRA√á√ÉO';
        }
    }

    verificarTipoA1() {
        try {
            // Certificado A1 √© armazenado em arquivo (n√£o em hardware)
            // Se conseguimos carregar a chave privada, √© A1
            return this.chavePrivada !== null;
        } catch (error) {
            return false;
        }
    }

    verificarAssinaturaDigital() {
        try {
            const extensions = this.certificado.extensions;
            const keyUsage = extensions.find(ext => ext.name === 'keyUsage');
            
            if (keyUsage && keyUsage.digitalSignature) {
                return true;
            }
            
            // Verificar Extended Key Usage
            const extKeyUsage = extensions.find(ext => ext.name === 'extKeyUsage');
            if (extKeyUsage) {
                // Procurar por OIDs relacionados √† assinatura digital
                return true; // Simplificado para este teste
            }
            
            return false;
        } catch (error) {
            return false;
        }
    }

    async testarConectividadeComCertificado() {
        console.log('\nüåê TESTE DE CONECTIVIDADE COM CERTIFICADO');
        console.log('=' .repeat(50));
        
        const urls = [
            'https://homologacao.nfe.fazenda.sp.gov.br/ws/nfeautorizacao4.asmx?wsdl',
            'https://nfe-homologacao.svrs.rs.gov.br/ws/NfeAutorizacao/NFeAutorizacao4.asmx?wsdl'
        ];
        
        // Converter certificado para PEM
        const certPem = forge.pki.certificateToPem(this.certificado);
        const keyPem = forge.pki.privateKeyToPem(this.chavePrivada);
        
        for (const url of urls) {
            console.log(`\nüîó Testando: ${url}`);
            
            try {
                // Teste 1: Sem certificado
                console.log('  üìù Teste 1: Sem certificado...');
                const response1 = await axios.get(url, {
                    timeout: 10000,
                    httpsAgent: new https.Agent({
                        rejectUnauthorized: false
                    })
                });
                console.log(`    Status: ${response1.status} - ${response1.status === 200 ? '‚úÖ OK' : '‚ùå ERRO'}`);
                
            } catch (error) {
                console.log(`    ‚ùå Erro: ${error.response?.status || error.code} - ${error.message}`);
            }
            
            try {
                // Teste 2: Com certificado
                console.log('  üîê Teste 2: Com certificado...');
                const response2 = await axios.get(url, {
                    timeout: 10000,
                    httpsAgent: new https.Agent({
                        cert: certPem,
                        key: keyPem,
                        rejectUnauthorized: false
                    })
                });
                console.log(`    Status: ${response2.status} - ${response2.status === 200 ? '‚úÖ OK' : '‚ùå ERRO'}`);
                
            } catch (error) {
                console.log(`    ‚ùå Erro: ${error.response?.status || error.code} - ${error.message}`);
            }
        }
    }

    async executarDiagnostico() {
        console.log('üöÄ DIAGN√ìSTICO COMPLETO DO CERTIFICADO PARA NFe');
        console.log('=' .repeat(60));
        
        // Carregar certificado
        const carregado = await this.carregarCertificado();
        if (!carregado) {
            console.log('‚ùå N√£o foi poss√≠vel carregar o certificado. Verifique o arquivo e senha.');
            return;
        }
        
        // Analisar certificado
        const analise = this.analisarCertificado();
        if (!analise) {
            console.log('‚ùå N√£o foi poss√≠vel analisar o certificado.');
            return;
        }
        
        // Testar conectividade
        await this.testarConectividadeComCertificado();
        
        // Resumo final
        console.log('\nüìä RESUMO DO DIAGN√ìSTICO');
        console.log('=' .repeat(30));
        
        console.log(`‚úÖ Certificado v√°lido: ${analise.valido ? 'SIM' : 'N√ÉO'}`);
        console.log(`‚úÖ CNPJ compat√≠vel: ${analise.cnpjCompativel ? 'SIM' : 'N√ÉO'}`);
        console.log(`‚úÖ Tipo A1: ${analise.tipoA1 ? 'SIM' : 'N√ÉO'}`);
        console.log(`‚úÖ Assinatura digital: ${analise.assinaturaDigital ? 'SIM' : 'N√ÉO'}`);
        
        if (analise.valido && analise.cnpjCompativel && analise.tipoA1 && analise.assinaturaDigital) {
            console.log('\nüéâ CERTIFICADO ADEQUADO PARA NFe!');
            console.log('\nüí° PR√ìXIMOS PASSOS:');
            console.log('1. Verificar se o CNPJ est√° credenciado na SEFAZ');
            console.log('2. Confirmar se o certificado foi instalado corretamente na SEFAZ');
            console.log('3. Testar com ambiente de produ√ß√£o se homologa√ß√£o n√£o funcionar');
            console.log('4. Verificar se h√° restri√ß√µes de IP ou firewall');
        } else {
            console.log('\n‚ö†Ô∏è  PROBLEMAS IDENTIFICADOS:');
            if (!analise.valido) console.log('- Certificado expirado ou inv√°lido');
            if (!analise.cnpjCompativel) console.log('- CNPJ do certificado n√£o confere');
            if (!analise.tipoA1) console.log('- Certificado n√£o √© do tipo A1');
            if (!analise.assinaturaDigital) console.log('- Certificado n√£o suporta assinatura digital');
        }
    }
}

// Executar diagn√≥stico
if (require.main === module) {
    const diagnostico = new DiagnosticoCertificado();
    diagnostico.executarDiagnostico().catch(error => {
        console.error('üí• Erro no diagn√≥stico:', error.message);
        process.exit(1);
    });
}

module.exports = DiagnosticoCertificado;